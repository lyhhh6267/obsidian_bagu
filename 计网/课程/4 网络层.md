# 一、 网络层提供的两种服务

## 1.1 虚电路服务

一种观点：让网络负责可靠交付

这种观点认为，应借助于电信网的成功经验，让网络负责可靠交付，计算机网络应模仿电信网络，使用面向连接的通信方式。

通信之前先建立**虚电路 (Virtual Circuit)**，以保证双方通信所需的一切网络资源。

如果再使用可靠传输的网络协议，就可使所发送的分组无差错按序到达终点，不丢失、不重复。

![[Pasted image 20221118152850.png]]

虚电路是逻辑连接

- 虚电路表示这只是一条逻辑上的连接，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
- 请注意，电路交换的电话通信是先建立了一条真正的连接。
- 因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。

## 1.2 数据报服务

另一种观点：网络提供数据报服务

- 互联网的先驱者提出了一种崭新的网络设计思路。
- 网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。
- 网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。
- 网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。

尽最大努力交付

- 由于传输网络不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉（与电信网的交换机相比较）。
- 如果主机（即端系统）中的进程之间的通信需要是可靠的，那么就由网络的主机中的运输层负责可靠交付（包括差错处理、流量控制等） 。
- 采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用。
- 互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

![[Pasted image 20221120144804.png]]

| 对比的方面     | 虚电路服务 | 数据报服务 |
| ----------- | ----------- | ----------- |
| 思路      | 可靠通信应当由网络来保证  | 可靠通信应当用户主机来保证  |
| 连接的建立   | 必须有        | 不需要       |
| 终点地址      | 仅在连接建立阶段使用，每个分组使用短的虚电路号       | 每个分组都有终点的完整地址       |
| 分组的转发   | 属于同一条虚电路的分组均按照同一路由进行转发        | 每个分组独立选择路由进行转发      |
| 当结点处故障时      | 所有通过出故障的结点的虚电路均不能工作       | 出故障的结点可能会丢失分组，一些路由可能会发生变化       |
| 分组的顺序   | 总是按发送顺序到达终点        | 到达终点时不一定按发送顺序       |
| 端到端的差错处理和流量控制      | 可以由网络负责，也可以由用户主机负责      | 由用户主机负责      |

# 二、网际协议IP


- 网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。

- 与 IP 协议配套使用的还有三个协议：
1. 地址解析协议 ARP (Address Resolution Protocol)
2. 网际控制报文协议 ICMP (Internet Control Message Protocol)
3. 网际组管理协议 IGMP (Internet Group Management Protocol)

![[Pasted image 20221120145845.png]]

## 2.1 虚拟互联网络

### 使用一些中间设备进行互连

- 将网络互相连接起来要使用一些中间设备。

- 中间设备又称为中间系统或中继 (relay)系统。

- 有以下五种不同的中间设备：
1. **物理层**中继系统：**转发器** (repeater)。
2. **数据链路层**中继系统：**网桥** (bridge)或**交换机**（switch）。
3. **网络层**中继系统：**路由器** (router)。
4. 网桥和路由器的**混合物：桥路器** (brouter)。

### 网络互连使用路由器

- 当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。

- 网络互连都是指用路由器进行网络互连和路由选择。

- 由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关。

### 虚拟互连网络的意义

- 所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。

- 使用 IP 协议的虚拟互连网络可简称为 IP 网。

- 如果在这种覆盖全球的 IP 网的上层使用 TCP 协议，那么就是现在的互联网 (Internet)。

![[Pasted image 20221120151010.png]]

![[Pasted image 20221120151019.png]]

![[Pasted image 20221120151031.png]]

## 2.2 分类的IP地址

### 2.2.1 IP地址及其表示方法

- IP 地址就是给每个连接在互联网上的主机（或路由器）分配一个在全世界范围是唯一的 32 位的标识符。
- IP 地址现在由互联网名字和数字分配机构ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。

#### IP地址的编址方法

- 分类的 IP 地址。这是最基本的编址方法，在1981年就通过了相应的标准协议。
- 子网的划分。这是对最基本的编址方法的改进，其标准[RFC 950]在1985年通过。
- 构成超网。这是比较新的无分类编址方法。1993年提出后很快就得到推广应用。

##### 分类IP地址

- 将IP地址划分为若干个固定类。
- 每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。
- 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
- 由此可见，一个 IP 地址在整个互联网范围内是唯一的。

![[Pasted image 20221120155915.png]]

![[Pasted image 20221120155932.png]]

![[Pasted image 20221120155946.png]]

![[Pasted image 20221120155953.png]]

![[Pasted image 20221120160010.png]]

![[Pasted image 20221120160019.png]]

#### IP地址的一些重要特点

1. **IP 地址是一种分等级的地址结构**。分两个等级的好处是：
  -  第一，IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就方便了 IP 地址的管理。
  - 第二，路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间。

2. **实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口。**
  - 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为**多归属主机** (multihomed host)。
  - 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此**一个路由器至少应当有两个不同的 IP 地址**.

  3. **用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id**。

  4. **所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的**。

## 2.3 IP地址与硬件地址

- IP 地址与硬件地址是不同的地址。
- 从层次的角度看，
	1. 硬件地址（或物理地址）是数据链路层和物理层使用的地址。
	2. IP 地址是网络层和以上各层使用的地址，是一种逻辑地址（称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的）。

![[Pasted image 20221124113027.png]]

## 2.4 地址解析协议ARP

通信时使用了两个地址：
IP 地址（网络层地址）
MAC 地址（数据链路层地址）

![[Pasted image 20221124113135.png]]

### 2.4.1 ARP 作用
从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。

![[Pasted image 20221124113212.png]]

不管网络层使用的是什么协议，**在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址**。 
每一个主机或路由器都设有一个 **ARP 高速缓存 (ARP cache)**，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

### 2.4.2 ARP要点

- ARP请求分组：包含发送方硬件地址 / 发送方 IP 地址 / 目标方硬件地址(未知时填 0) / 目标方 IP 地址。
- 本地广播 ARP 请求（路由器不转发ARP请求）。
- ARP 响应分组：包含发送方硬件地址 / 发送方 IP地址 / 目标方硬件地址 / 目标方 IP 地址。
- ARP 分组封装在物理网络的帧中传输。

![[Pasted image 20221124113358.png]]

### 2.4.3 ARP高速缓存的作用

- 存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。
- 为了减少网络上的通信量，主机 A 在发送其 ARP 请求分组时，就将自己的 IP 地址到硬件地址的映射写入 ARP 请求分组。
- 当主机 B 收到 A 的 ARP 请求分组时，就将主机 A 的这一地址映射写入主机 B 自己的 ARP 高速缓存中。这对主机 B 以后向 A 发送数据报时就更方便了。 

### 2.4.4 注意

- ARP 用于解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。
- 如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。
- 从 IP 地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。
- 只要主机或路由器要和本网络上的另一个已知 IP 地址的主机或路由器进行通信，ARP 协议就会自动地将该 IP 地址解析为链路层所需要的硬件地址。 

### 2.4.5 使用ARP的四种情况

1. 发送方是主机，要把 IP 数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址。 

![[Pasted image 20221124113542.png]]

2. 发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

![[Pasted image 20221124113610.png]]


3. 发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址。 

![[Pasted image 20221124113631.png]]

4. 发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上另一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

![[Pasted image 20221124113650.png]]

## 2.5 IP数据报的格式

一个 IP 数据报由首部和数据两部分组成。
首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。
在首部的固定部分的后面是一些可选字段，其长度是可变的。 

![[Pasted image 20221124113835.png]]

![[Pasted image 20221124114008.png]]

### 例题4-1：

一数据报的总长度为 3820 字节，其数据部分的长度为 3800 字节（使用固定首部），需要分片为长度不超过 1420 字节的数据报片。
由于MTU的限制，因此每个数据报片的数据部分长度不能超过 1400 字节。
于是分为 3 个数据报片，其数据部分的长度分别为 1400、1400 和 1000 字节。
原始数据报首部被复制为各数据报片的首部，但必须修改有关字段的值。

![[Pasted image 20221124113917.png]]

![[Pasted image 20221124113939.png]]

## 2.6 IP层转发分组的流程

假设：有四个 A 类网络通过三个路由器连接在一起。每一个网络上都可能有成千上万个主机。
可以想象，**若按目的主机号来制作路由表**，每一个路由表就有 4 万个项目，即 4 万行（每一行对应于一台主机），则所得出的路由表就会过于庞大。
但**若按主机所在的网络地址来制作路由表**，那么每一个路由器中的路由表就只包含 4 个项目（每一行对应于一个网络），这样就可使路由表大大简化。 

![[Pasted image 20221124114158.png]]

### 2.6.1 查找路由表

根据目的网络地址就能确定下一跳路由器，这样做的结果是：
- IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）。
- 只有到达最后一个路由器时，才试图向目的主机进行直接交付。 

虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。

采用特定主机路由可使网络管理人员能更方便地控制网络和测试网络，同时也可在需要考虑某种安全问题时采用这种特定主机路由。 

### 2.6.2 默认路由

- 路由器还可采用默认路由以减少路由表所占用的空间和搜索路由表所用的时间。

- 这种转发方式在一个网络只有很少的对外连接时是很有用的。

- 如果一个主机连接在一个小网络上，而这个网络只用一个路由器和互联网连接，那么在这种情况下使用默认路由是非常合适的。 

![[Pasted image 20221124114740.png]]

IP 数据报的首部中**没有**地方可以用来指明“下一跳路由器的 IP 地址”。

当路由器收到待转发的数据报，不是将下一跳路由器的 IP 地址填入 IP 数据报，而是**送交下层**的网络接口软件。

网络接口软件**使用 ARP** 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。 

### 2.6.3 路由器分组转发算法

1. 从数据报的首部提取目的主机的 IP 地址 D, 得出目的网络地址为 N。
2. 若网络 N 与此路由器直接相连，则把数据报直接交付目的主机 D；否则是间接交付，执行 (3)。
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行 (4)。
4. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行 (5)。
5. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行 (6)。
6. 报告转发分组出错。 


- 路由表没有给分组指明到某个网络的完整路径。
- 路由表指出，到某个网络应当先到某个路由器（即下一跳路由器）。
- 在到达下一跳路由器后，再继续查找其路由表，知道再下一步应当到哪一个路由器。
- 这样一步一步地查找下去，直到最后到达目的网络。


# 三、划分子网和构造超网


## 3.1 划分子网

从 1985 年起在 IP 地址中又增加了一个“**子网号字段**”，使两级的 IP 地址变成为**三级的 IP 地址**。
这种做法叫做**划分子网** (subnetting) 。
划分子网已成为互联网的**正式标准协议**。 

### 3.1.1 划分子网的基本思路

划分子网纯属一个单位内部的事情。单位对外仍然表现为没有划分子网的网络。
从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。
凡是从其他网络发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。

然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。

最后就将 IP 数据报直接交付目的主机。 
![[Pasted image 20221124120255.png]]


![[Pasted image 20221124120204.png]]

![[Pasted image 20221124120216.png]]

当没有划分子网时，IP 地址是两级结构。
划分子网后 IP 地址就变成了**三级结构**。
划分子网只是把 IP 地址的主机号 host-id 这部分进行再划分，而**不改变 IP 地址原来的网络号 net-id**。 

优点：
	1. 使网络的组织更加灵活
	2. 更便于维护和管理

划分子网纯属一个单位内部的事情，对外部网络透明，对外仍然表现为没有划分子网的一个网络。

### 3.1.2 子网掩码

从一个 **IP 数据报的首部**并**无法判断**源主机或目的主机所连接的网络是否进行了子网划分。
使用**子网掩码** (subnet mask) 可以找出 IP 地址中的子网部分。  

规则：
子网掩码长度 ＝ 32 位
子网掩码左边部分的一连串 1，对应于网络号和子网号
子网掩码右边部分的一连串 0，对应于主机号 

![[Pasted image 20221124120531.png]]

![[Pasted image 20221124120540.png]]

![[Pasted image 20221124120549.png]]

**子网掩码是一个网络或一个子网的重要属性**。

- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。
- 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码。
- 若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。

子网划分方法：

- 有**固定长度子网**和**变长子网**两种子网划分方法。
- **在采用固定长度子网时，所划分的所有子网的子网掩码都是相同的。**
- 虽然根据已成为互联网标准协议的 RFC 950 文档，子网号不能为**全 1** 或**全 0**，但随着无分类域间路由选择 CIDR 的广泛使用，现在全 1 和全 0 的子网号也可以使用了，但一定要谨慎使用，确认你的路由器所用的路由选择软件是否支持全 0 或全 1 的子网号这种较新的用法。

划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。
  （怎么理解？）

### 例4-2

已知 IP 地址是 141.14.72.24，子网掩码是 255.255.192.0。试求网络地址。 

![[Pasted image 20221124120751.png]]

### 例4-3

上例中，若子网掩码改为 255.255.224.0，试求网络地址，讨论所得结果。 

![[Pasted image 20221124120819.png]]


## 3.2 使用子网时分组的转发

在不划分子网的两级 IP 地址下，从 IP 地址得出网络地址是个很简单的事

但在划分子网的情况下，从 IP 地址却不能唯一地得出网络地址来，这是因为网络地址取决于那个网络所采用的子网掩码，但数据报的首部并没有提供子网掩码的信息。

因此分组转发的算法也必须做相应的改动。 

### 3.2.1 在划分子网情况下路由器转发分组的算法

1. 从收到的分组的首部提取目的 IP 地址 D。
2. 先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。
3. 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行 (4)。
4. 对路由表中的每一行，将子网掩码和 D 逐位相“与”。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行 (5)。
5. 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行 (6)。
6. 报告转发分组出错。

### 例4-4

【例4-4】已知互联网和路由器 R1 中的路由表。主机 H1 向 H2 发送分组。试讨论 R1 收到 H1 向 H2 发送的分组后查找路由表的过程。 

![[Pasted image 20221124122141.png]]

![[Pasted image 20221124122155.png]]

## 3.3 五分类编址CIDR（构造超网）

### 3.3.1 网络前缀

划分子网在一定程度上缓解了互联网在发展中遇到的困难。然而在 1992 年互联网仍然面临三个必须尽早解决的问题：
- B 类地址在 1992 年已分配了近一半，眼看就要在 1994 年 3 月全部分配完毕！
- 互联网主干网上的路由表中的项目数急剧增长（从几千个增长到几万个）。
- 整个 IPv4 的地址空间最终将全部耗尽（2019年11月25日ICANN已经发放完了）。

使用**变长子网掩码 VLSM** (Variable Length Subnet Mask)可进一步提高 IP 地址资源的利用率。
在 VLSM 的基础上又进一步研究出无分类编址方法，它的正式名字是**无分类域间路由选择 CIDR** (Classless Inter-Domain Routing)。 

### 3.3.2 CIDR

#### CIDR 最主要的特点

CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。（如何理解？）
CIDR使用各种长度的“**网络前缀**”(network-prefix)来代替分类地址中的网络号和子网号。（让net-id长度也可变）
**IP 地址从三级编址（使用子网掩码）又回到了两级编址。** 

#### 无分类的两级编址

![[Pasted image 20221124125845.png]]
CIDR 使用“斜线记法”(slash notation)，它又称为 CIDR 记法，即在 IP 地址后面加上一个斜线“/”，然后写上网络前缀所占的位数（这个数值对应于三级编址中子网掩码中 1 的个数）。例如： 220.78.168.0/24

#### CIDR 地址块

- CIDR 把网络前缀都相同的连续的 IP 地址组成“CIDR 地址块”。
- 128.14.32.0/20 表示的地址块共有 212 个host-id（因为斜线后面的 20 是网络前缀的位数，所以这个地址的主机号是 12 位）。
	1. 这个地址块的起始地址是 128.14.32.0。
	2. 在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。
	3. 128.14.32.0/20 地址块的最小地址：128.14.32.0
	4. 128.14.32.0/20 地址块的最大地址：128.14.47.255
	5. 全 0 和全 1 的主机号地址一般不使用。

![[Pasted image 20221124130221.png]]

#### 路由聚合

一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为**路由聚合**，它使得路由表中的一个项目可以表示很多个（例如上千个）原来传统分类地址的路由。

路由聚合有利于**减少**路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。

**路由聚合也称为构成超网** (supernetting)。

CIDR 虽然不使用子网了，但仍然使用“**掩码**”这一名词（但不叫子网掩码）。
对于 /20  地址块，它的掩码是 20 个连续的 1。 斜线记法中的数字就是掩码中1的个数。 

### 3.3.2 最长前缀匹配

使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。**在查找路由表时可能会得到不止一个匹配结果。** 
应当从匹配结果中选择具有最长网络前缀的路由：**最长前缀匹配** (longest-prefix matching)。
网络前缀越长，其地址块就越小，因而路由就越具体 (more specific) 。
最长前缀匹配又称为**最长匹配**或**最佳匹配**。

![[Pasted image 20221124131218.png]]

![[Pasted image 20221124131233.png]]

# 四、网际控制报文协议ICMP

- 为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。
- ICMP 是互联网的标准协议。
- ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。
- 但 ICMP 不是高层协议（看起来好像是高层协议，因为 ICMP 报文是装在 IP 数据报中，作为其中的数据部分），而是 IP 层的协议。

![[Pasted image 20221124194542.png]]

## 4.1 ICMP报文的种类

- ICMP 报文的种类有两种，即 ICMP **差错报告报文**和 ICMP **询问报文**。 
- ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即**类型、代码和检验和**。接着的 4 个字节的内容与 ICMP 的类型有关。 

 ICMP **差错报告报文**：
	 终点不可达 
	 时间超过 
	 参数问题 
	 改变路由（重定向）(Redirect) 

ICMP 询问报文：
	回送请求和回答报文
	时间戳请求和回答报文


## 4.2 ICMP的应用举例

**PING** (Packet InterNet Groper) 
- **PING 用来测试两个主机之间的连通性**。
- PING 使用了 ICMP 回送请求与回送回答报文。
- PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。 


# 五、互联网的路由选择协议


## 5.1 有关路由选择协议的几个基本概念

### 5.1.1 理想的路由算法

算法必须是正确的和完整的。 
算法在计算上应简单。 
算法应能适应通信量和网络拓扑的变化，这就是说，要有自适应性。 
算法应具有稳定性。 
算法应是公平的。 
算法应是最佳的。 

关于最佳路由：
- 不存在一种绝对的最佳路由算法。
- **所谓“最佳”只能是相对于某一种特定要求下得出的较为合理的选择而已**。
- 实际的路由选择算法，应尽可能接近于理想的算法。 
- 路由选择是个非常复杂的问题
	1. 它是网络中的所有结点共同协调工作的结果。
	2. 路由选择的环境往往是不断变化的，而这种变化有时无法事先知道。

从路由算法的自适应性考虑：

**静态**路由选择策略——即**非自适应路由选择**，其特点是简单和开销较小，但不能及时适应网络状态的变化。 (需要人为参与)

**动态**路由选择策略——即**自适应路由选择**，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。 （设计不好路由表会特别大）

### 5.1.2 分层次的路由选择协议

互联网采用**分层次**的路由选择协议。这是因为：
1. 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种**路由表将非常大**，处理起来也太花时间。而所有这些路由器之间交换路由信息所需的带宽就会使互联网的通信链路饱和。
2. 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于**本部门内部的事情**），但同时还希望连接到互联网上。 

#### 自治系统 AS (Autonomous System) 

**自治系统 AS 的定义**：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的**路由选择协议**和**共同的度量（Metrics）**。

现在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但**重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略**。

![[Pasted image 20221124200646.png]]

### 5.1.3 互联网有两大类路由选择协议

**内部网关协议** IGP (Interior Gateway Protocol)  
	1. 在一个自治系统**内部使用**的路由选择协议。
	2. 目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。

**外部网关协议** EGP (External Gateway Protocol) 
	1. 若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。
	2. 在外部网关协议中目前使用最多的是 BGP-4。 

![[Pasted image 20221124200827.png]]

## 5.2 内部网关协议RIP

### 5.2.1 工作原理

- 路由信息协议 RIP (Routing Information Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议。
- RIP 是一种**分布式的、基于距离向量的路由选择协议**。
- **RIP 协议要求**网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。 

#### 距离的定义

- 从一个路由器到**直接连接**的网络的距离定义为 1。
- 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。
- RIP 协议中的“距离”也称为“**跳数**”(hop count)，因为每经过一个路由器，跳数就加 1。
- RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。
- RIP 允许一条路径最多只能包含 15 个路由器。
- “距离”的最大值为 16 时即相当于不可达。可见 RIP 只适用于小型互联网。
- RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。

#### RIP协议的三个特点

1. 和谁交换——仅和相邻路由器交换信息。
2. 交换什么——交换的信息是当前本路由器所知道的全部信息，即自己的路由表。
3. 交换频率——按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

#### 路由表的建立

1. 路由器在刚刚开始工作时，只知道到直接连接的网络的距离（此距离定义为 1）。它的路由表是空的。
2. 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
3. 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。
4. RIP 协议的收敛 (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。

#### 路由器之间交换信息与路由表更新

RIP 协议让互联网中的所有路由器都和自己的相邻路由器不断交换路由信息，并不断更新其路由表，使得从每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）。

虽然所有的路由器最终都拥有了整个自治系统的全局路由信息，但由于每一个路由器的位置不同，它们的路由表当然也应当是不同的。

### 5.2.2 距离向量算法

路由器收到相邻路由器（其地址为 X）的一个 RIP 报文：
(1) 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。
(2) 对修改后的 RIP 报文中的每一个项目，重复以下步骤：
     若项目中的目的网络不在路由表中，则把该项目加到路由表中。
         否则
             若下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。
                否则 
                    若收到项目中的距离小于路由表中的距离，则进行更新，
	     否则，什么也不做。
(3) 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）。
(4) 返回。


#### 例4-5

![[Pasted image 20221125144952.png]]

#### 例：路由表更新

![[Pasted image 20221125144928.png]]

### 5.2.3 RIP2协议的报文格式

![[Pasted image 20221125145501.png]]

#### RIP 协议特点

好消息传播得快，坏消息传播得慢。

RIP 存在的一个问题：当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器。

#### RIP 协议的优缺点

优点：
	1. 实现简单，开销较小。

缺点：
	1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）
	2. 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
	3. “坏消息传播得慢”，使更新过程的收敛时间过长。


## 5.3 内部网关协议OSPF

**开放最短路径优先 OSPF** (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的。

OSPF 的原理很简单，但实现起来却较复杂。

### 5.3.1 OSPF 协议的基本特点

“**开放**”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。

“**最短路径优先**”是因为使用了 Dijkstra 提出的最短路径算法 SPF

采用**分布式的链路状态协议** (link state protocol)。

注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

#### 三个要点

**和谁交换**——向本自治系统中所有路由器发送信息，这里使用的方法是**洪泛法**。

**交换什么**——发送的信息就是与本路由器**相邻**的所有路由器的链路状态，但这只是路由器所知道的**部分信息**。
	“**链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)。**

**交换频率**——只有当链路状态**发生变化**时，路由器才用洪泛法向所有路由器发送此信息（克服坏消息传的慢）。

#### OSPF的区域（area）

为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域。

每一个区域都有一个 32 位的区域标识符（用点分十进制表示）。

区域也不能太大，在一个区域内的路由器最好不超过 200 个。

![[Pasted image 20221125150736.png]]

划分区域的**好处**就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。

**在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。**

OSPF 使用**层次结构的区域划分**。在上层的区域叫做**主干区域** (backbone area)。

主干区域的标识符规定为0.0.0.0。主干区域的**作用**是用来连通其他在下层的区域。

#### OSPF 直接用 IP 数据报传送

OSPF 不用 UDP 而是直接用 IP 数据报传送。

OSPF 构成的数据报很短。这样做可减少路由信息的通信量。

数据报很短的另一好处是可以不必将长的数据报分片传送。

#### OSPF分组

![[Pasted image 20221125150909.png]]

### 5.3.2 OSPF的五种分组类型

- 类型1，问候 (Hello) 分组。
- 类型2，数据库描述 (Database Description) 分组。
- 类型3，链路状态请求 (Link State Request) 分组。
- 类型4，链路状态更新 (Link State Update) 分组，用洪泛法对全网更新链路状态。
- 类型5，链路状态确认 (Link State Acknowledgment)分组。

#### OSPF 的基本操作

![[Pasted image 20221125151025.png]]

![[Pasted image 20221125151036.png]]

#### OSPF的其他特点

OSPF 还规定每隔一段时间，如 30 分钟，要刷新一次数据库中的链路状态。

OSPF 没有“坏消息传播得慢”的问题，据统计，其响应网络变化的时间小于 100 ms。

## 5.4 外部网关协议BGP

BGP 是不同自治系统的路由器之间交换路由信息的协议。

BGP 较新版本是 2006 年 1 月发表的 BGP-4（BGP 第 4 个版本），即 RFC 4271 ~ 4278。

可以将 BGP-4 简写为 BGP。

### 5.4.1 BGP 使用环境不同

互联网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。
	1.当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。
	2.比较合理的做法是在 AS 之间交换“可达性”信息。

因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。

### 5.4.2 BGP发言人

每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ **BGP 发言人**” (BGP speaker) 。

一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。

![[Pasted image 20221125153114.png]]

一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话(session)，利用 BGP 会话交换路由信息。

使用 TCP 连接能提供可靠的服务。

使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(neighbor)或对等站(peer) 。

#### BGP 协议的特点

**和谁交换——相邻BGP发言人之间互相交换信息**。BGP 协议交换路由信息的结点数量级是**自治系统数的量级**，这要比这些自治系统中的网络数少很多。

**交换什么——交换发言人的路由表**。BGP 支持 CIDR，因此 BGP 的路由表也就应当**包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。**

交换频率——在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时**更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销都有好处。**

#### BGP-4 共使用四种报文

1.打开 (OPEN) 报文，用来与相邻的另一个BGP发言人建立关系。

2.更新 (UPDATE) 报文，用来发送某一路由的信息，以及列出要撤消的多条路由。

3.保活 (KEEPALIVE) 报文，用来确认打开报文和周期性地证实邻站关系。

4.通知 (NOTIFICATION) 报文，用来发送检测到的差错。

## 5.5 路由器的构成

路由器是互联网中的关键设备。

路由器的主要作用是：
	1.连通不同的网络。
	2.选择信息传送的线路。选择通畅快捷的近路，能大大提高通信速度，减轻网络系统通信负荷，节约网络系统资源，提高网络系统畅通率，从而让网络系统发挥出更大的效益来。

![[Pasted image 20221125153747.png]]

### 5.5.1 “转发”和“路由选择”的区别

“**转发**”(forwarding) 就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。

“**路由选择**”(routing) 则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由。

**路由表是根据路由选择算法得出的。而转发表是从路由表得出的。**

在讨论路由选择的原理时，往往不去区分转发表和路由表的区别。

![[Pasted image 20221125153839.png]]

![[Pasted image 20221125153848.png]]

# 六、IPv6

IP 是互联网的核心协议。
互联网经过几十年的飞速发展，IPv4 的 32 位地址已经耗尽。
ISP 已经不能再申请到新的 IP 地址块了。

我国在 2014 – 2015 年也逐步停止了向新用户和应用分配 IPv4 地址。
解决 IP 地址耗尽的根本措施就是采用具有更大地址空间的新版本的 IP，即 IPv6。

## 6.1 IPv6 的基本首部

IPv6 仍支持无连接的传送，但将协议数据单元 PDU 称为分组。为方便起见，本书仍采用数据报这一名词。

所引进的主要变化如下：
1. **更大的地址空间**。IPv6 将地址从 IPv4 的 32 位 增大到了 128 位。
2. **扩展的地址层次结构**。
3. **灵活的首部格式**。 IPv6 定义了许多可选的扩展首部。
4. **改进的选项**。 IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中。
5. **允许协议继续扩充**。
6. *支持即插即用（即自动配置）。因此 IPv6 不需要使用 DHCP。
7. **支持资源的预分配**。  IPv6 支持实时视像等要求，保证一定的带宽和时延的应用。
8. **IPv6 首部改为 8 字节对齐**。首部长度必须是 8 字节的整数倍。原来的 IPv4 首部是 4 字节对齐。

### 6.1.1 数据报的基本首部

- IPv6 将首部长度变为固定的 40 字节，称为基本首部。
- 把首部中不必要的功能取消了，使得 IPv6 首部的字段数减少到只有 8 个。
- IPv6 对首部中的某些字段进行了如下的更改：
	- 取消了首部长度字段，因为首部长度是固定的 40 字节；
	- 取消了服务类型字段；
	- 取消了总长度字段，改用有效载荷长度字段；
	- 把 TTL 字段改称为跳数限制字段；
	- 取消了协议字段，改用下一个首部字段；
	- 取消了检验和字段；
	- 取消了可选字段，而用扩展首部来实现选项功能。

![[Pasted image 20221126152644.png]]

![[Pasted image 20221126152656.png]]

### 6.1.2 IPv6 的扩展首部

- IPv6 把原来 IPv4 首部中选项的功能都放在**扩展首部**中，并将扩展首部留给路径两端的源站和目的站的主机来处理。
- **数据报途中经过的路由器都不处理这些扩展首部**。
- 这样就**大大提高了路由器的处理效率**。

## 6.2 IPv6的地址

IPv6 数据报的目的地址可以是以下三种基本类型地址之一：
1. 单播 (unicast)：传统的点对点通信。
2. 多播 (multicast)：一点对多点的通信。
3. 任播 (anycast)：这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一个，通常是距离最近的一个。

### 6.2.1 IPv6 结点与接口

- IPv6 将实现 IPv6 的主机和路由器均称为结点。
- 一个结点就可能有多个与链路相连的接口。
- IPv6 地址是分配给结点上面的接口的。
	1. 一个接口可以有多个单播地址。
	2. 其中的任何一个地址都可以当作到达该结点的目的地址。即一个结点接口的单播地址可用来唯一地标志该结点。

### 6.2.2 冒号十六进制记法

- 在 IPv6 中，每个地址占 128 位。
- 为了使地址再稍简洁些，IPv6 使用冒号十六进制记法(colon hexadecimal notation, 简写为 colon hex)。
- 每个 16 位的值用十六进制值表示，各值之间用冒号分隔。例如：
			68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF
- 在十六进制记法中，允许把数字前面的 0 省略。例如把 0000 中的前三个 0 省略，写成 1 个 0。

#### 零压缩

冒号十六进制记法可以允许零压缩 (zero compression)，即一连串连续的零可以为一对冒号所取代。

    FF05:0:0:0:0:0:0:B3    可压缩为：  

    FF05::B3

注意：在任一地址中只能使用一次零压缩。

![[Pasted image 20221126153643.png]]

### 6.2.2 IPv6 地址分类


| 地址类型      | 二进制前缀 |
| ----------- | ----------- |
| 未指明地址      | 00…0（128位），可记为 ::/128       |
| 环回地址   | 00…1（128位），可记为 ::/128        |
| 多播地址      | 11111111（8位），可记为 FF00::/8       |
| 本地链路单播地址   | 1111111010（10位）, 可记为 FE80::/10        |
| 全球单播地址      | （除上述四种外，所有其他的二进制前缀）       |

#### 未指明地址

1. 这是 16 字节的全 0 地址，可缩写为两个冒号“::”。
2. 这个地址只能为还没有配置到一个标准的 IP 地址的主机当作源地址使用。
3. 这类地址仅此一个。

#### 环回地址

1. 即 0:0:0:0:0:0:0:1（记为 ::1）。
2. 作用和 IPv4 的环回地址一样。
3. 这类地址也是仅此一个。

#### 多播地址

1. 功能和 IPv4 的一样。
2. 这类地址占 IPv6 地址总数的 1/256。

#### 本地链路单播地址 (Link-Local Unicast Address)

1. 有些单位的网络使用 TCP/IP 协议，但并没有连接到互联网上。连接在这样的网络上的主机都可以使用这种本地地址进行通信，但不能和互联网上的其他主机通信。
2. 这类地址占 IPv6 地址总数的 1/1024。

#### 全球单播地址

1. IPv6 的这一类单播地址是使用得最多的一类。
2. 曾提出过多种方案来进一步划分这 128 位的单播地址。
3. 根据 2006 年发布的草案标准 RFC 4291 的建议，  IPv6 单播地址的划分方法非常灵活。

![[Pasted image 20221126154110.png]]

## 6.3 从 IPv4 向 IPv6 过渡


向 IPv6 过渡只能采用逐步演进的办法，同时，还必须使新安装的 IPv6 系统能够向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。

两种向 IPv6 过渡的策略：
	1.使用双协议栈
	2.使用隧道技术

#### 双协议栈

双协议栈 (dual stack) 是指在完全过渡到 IPv6 之前，使一部分主机（或路由器）**装有两个协议栈，一个 IPv4 和一个 IPv6。**

双协议栈的主机（或路由器）记为 IPv6/IPv4，表明它**同时具有两种 IP 地址：一个 IPv6 地址和一个 IPv4 地址。**

双协议栈主机在和 IPv6 主机通信时是采用 IPv6 地址，而和 IPv4 主机通信时就采用 IPv4 地址。

![[Pasted image 20221126174027.png]]

#### 隧道技术

在 IPv6 数据报要进入 IPv4 网络时，**把 IPv6 数据报封装成为 IPv4 数据报**，整个的 IPv6 数据报变成了 IPv4 数据报的数据部分。

当 IPv4 数据报离开 IPv4 网络中的隧道时，再把数据部分（即原来的 IPv6 数据报）交给主机的 IPv6 协议栈。

![[Pasted image 20221126174105.png]]


## 6.4 ICMPv6

IPv6 也不保证数据报的可靠交付，因为互联网中的路由器可能会丢弃数据报。

因此 IPv6 也需要使用 ICMP 来反馈一些差错信息。新的版本称为 ICMPv6。

地址解析协议 ARP 和网际组管理协议 IGMP 协议的功能都已被合并到 ICMPv6 中。

![[Pasted image 20221126182929.png]]

# 七、IP多播

## 7.1 IP多播的基本概念

IP 多播 (multicast，以前曾译为组播) 已成为互联网的一个热门课题。

目的：更好地支持**一对多通信**。

一对多通信：一个源点发送到许多个终点。
	• 例如，实时信息的交付（如新闻、股市行情等），软件更新，交互式会议及其他多媒体通信。

![[Pasted image 20221126183415.png]]

![[Pasted image 20221126183427.png]]

### 7.1.1 IP多播

- 在互联网上进行多播就叫做 **IP 多播**。
- 互联网范围的多播要靠路由器来实现。
- 能够运行多播协议的路由器称为**多播路由器**(multicast router)。当然它也可以转发普通的单播IP数据报。
- 从 1992 年起，在互联网上开始试验虚拟的**多播主干网 MBONE** (Multicast Backbone On the Internet)。 现在多播主干网已经有了相当大的规模。

#### 多播IP地址

- IP 多播所传送的分组需要使用多播 IP 地址。
- 在多播数据报的目的地址写入的是多播组的标识符。
- 多播组的标识符就是 IP 地址中的 D 类地址（多播地址）。
- 每一个 D 类地址标志一个多播组。
- 多播地址只能用于目的地址，不能用于源地址。

#### 多播数据报

多播数据报和一般的 IP 数据报的区别就是它**使用 D 类 IP 地址**作为目的地址，并且首部中的协议字段值是 2，表明**使用网际组管理协议 IGMP**。

![[Pasted image 20221126184256.png]]

#### 多播数据报的特点

多播数据报也是“尽最大努力交付（UDP）”，不保证一定能够交付多播组内的所有成员。看直播的时候，可能会掉帧。

对多播数据报不产生 ICMP 差错报文。因此，若在 PING 命令后面键入多播地址，将永远不会收到响应。

#### 分级的组播

![[Pasted image 20221126184421.png]]

## 7.2 在局域网上进行硬件多播

## 7.3 网际组管理协议IGMP和多播路由选择协议

### 7.3.1 IP多播需要两种协议

为了使路由器知道多播组成员的信息，需要利用**网际组管理协议 IGMP** (Internet Group Management Protocol)。

连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用**多播路由选择协议**。

![[Pasted image 20221126184650.png]]

### 7.3.2 IGMP

![[Pasted image 20221126184710.png]]

#### IGMP 的使用范围

- IGMP **并非**在互联网范围内对所有多播组成员进行管理的协议。
- IGMP **不知道** IP 多播组包含的成员数，**也不知道**这些成员都分布在哪些网络上。
- **IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机（严格讲，是主机上的某个进程）参加或退出了某个多播组**。

#### IGMP工作可分为两个阶段

第一阶段：加入多播组。
	1. 当某个主机加入新的多播组时，该主机应向多播组的多播地址发送 IGMP 报文，声明自己要成为该组的成员。
	2. 本地的多播路由器收到 IGMP 报文后，将组成员关系转发给互联网上的其他多播路由器。

第二阶段：探询组成员变化情况。
	1. 因为组成员关系是动态的，因此本地多播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。
	2. 只要对某个组有一个主机响应，那么多播路由器就认为这个组是活跃的。
	3. 但一个组在经过几次的探询后仍然没有一个主机响应，则不再将该组的成员关系转发给其他的多播路由器。

### 7.3.3 多播路由选择

![[Pasted image 20221126185323.png]]

#### 多播路由选择协议更为复杂

单播路由选择通常是在网络拓扑发生变化时才需要更新路由，而多播转发必须**动态地适应多播组成员的变化**（这时网络拓扑并未发生变化）。

多播路由器在转发多播数据报时，不能仅仅根据多播数据报中的**目的地址**，而是还要考虑这个多播数据报**从什么地方来和要到什么地方去**。

多播数据报**可以由没有加入多播组的主机发出**，也可以通过没有组成员接入的网络。

#### 多播路由选择协议在转发多播数据报时使用三种方法

##### 洪泛与剪除

- 这种方法适合于较小的多播组，而所有的组成员接入的局域网也是相邻接的。
- 一开始，路由器转发多播数据报使用洪泛的方法（这就是广播）。
- 为了避免兜圈子，采用了叫做**反向路径广播 RPB** (Reverse Path Broadcasting) 的策略。

###### RPB 的要点

- 路由器收到多播数据报时，先**检查它是否是从源点经最短路径传送来的**。
- 若是，就向所有其他方向转发刚才收到的多播数据报（但进入的方向除外），否则就丢弃而不转发。
- 如果存在几条同样长度的最短路径，那么只能选择一条最短路径，选择的准则就是看这几条最短路径中的相邻路由器谁的 IP 地址最小。
- **最后就得出了用来转发多播数据报的多播转发树**，以后就按这个多播转发树转发多播数据报。避免了多播数据报的兜圈子，同时每一个路由器也不会接收重复的多播数据报。
- 如果在多播转发树上的某个路由器发现它的下游树枝（即叶节点方向）已没有该多播组的成员，就应把它和下游的树枝一起剪除。
- 当某个树枝有新增加的组成员时，可以再接入到多播转发树上。

![[Pasted image 20221126185557.png]]


##### 隧道技术 (tunneling)

![[Pasted image 20221126185846.png]]

##### 基于核心的发现技术（不做讲解）

# 八、虚拟专用网 VPN和网络地址转换 NAT

## 8.1 本地地址与全球地址

- 由于 IP 地址的紧缺，一个机构能够申请到的IP地址数往往远小于本机构所拥有的主机数（不是想要多少，就有多少）。
- 考虑到互联网并不很安全，一个机构内也并不需要把所有的主机接入到外部的互联网。
- 假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其 IP 地址。

**本地地址**——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向互联网的管理机构申请。

**全球地址**——全球唯一的 IP 地址，必须向互联网的管理机构申请。

问题：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。
问题：在内部使用的本地地址就有可能和互联网中某个 IP 地址重合，这样就会出现地址的二义性问题。

解决：RFC 1918 指明了一些专用地址 (private address)。专用地址只能用作本地地址而不能用作全球地址。在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发。

![[Pasted image 20221126174546.png]]

采用这样的专用 IP 地址的互连网络称为**专用互联网**或**本地互联网**，或更简单些，就叫做**专用网**。

因为这些专用地址仅在本机构内部使用。专用IP地址也叫做**可重用地址** (reusable address)。


## 8.2虚拟专用网VPN

如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的**数据都必须加密**。

一个机构要构建自己的 VPN 就必须为它的每一个场所购买专门的硬件和软件，并进行配置，使每一个场所的 VPN 系统都知道其他场所的地址。

![[Pasted image 20221126174644.png]]

![[Pasted image 20221126174653.png]]

#### 远程接入VPN

远程接入 VPN (remote access VPN)可以满足外部流动员工访问公司网络的需求。

在外地工作的员工拨号接入互联网，而驻留在员工 PC 机中的 VPN 软件可在员工的 PC 机和公司的主机之间建立 VPN 隧道，因而外地员工与公司通信的内容是保密的，员工们感到好像就是使用公司内部的本地网络。


#### 内联网 intranet 和外联网 extranet

它们都是基于 TCP/IP 协议的。

由部门 A 和 B 的内部网络所构成的虚拟专用网 VPN 又称为内联网 (intranet)，表示部门 A 和 B 都是在同一个机构的内部。

一个机构和某些外部机构共同建立的虚拟专用网 VPN 又称为外联网 (extranet)。

![[Pasted image 20221126174745.png]]

## 8.3 网络地址转换NAT

网络地址转换 NAT (Network Address Translation)  方法于1994年提出。

需要在专用网连接到互联网的路由器上安装 NAT 软件。装有 NAT 软件的路由器叫做 **NAT路由器，它至少有一个有效的外部全球IP地址（可以有多个）。**

所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器**上将其本地地址转换成全球 IP 地址**，才能和互联网连接。

![[Pasted image 20221126180534.png]]

当 NAT 路由器具有 n 个全球 IP 地址时，专用网内**最多可以同时有 n 台主机接入到互联网**。这样就可以使专用网内较多数量的主机，轮流使用 NAT 路由器有限数量的全球 IP 地址。

通过 NAT 路由器的通信必须由专用网内的主机发起。**专用网内部的主机不能充当服务器用**，因为互联网上的客户无法请求专用网内的服务器提供服务。

#### 网络地址与端口号转换 NAPT

为了更加有效地利用 NAT 路由器上的全球IP地址，现在常用的 NAT 转换表**把运输层的端口号也利用上**。这样，就可以使多个拥有本地地址的主机，**共用一个 NAT 路由器上的全球 IP 地址**，因而可以同时和互联网上的不同主机进行通信。

使用端口号的 NAT 叫做**网络地址与端口号转换NAPT** (Network Address and Port Translation)，而不使用端口号的 NAT 就叫做传统的 NAT (traditional NAT)。

![[Pasted image 20221126180640.png]]

# 九、多协议标记交换MPLS

IETF于1997年成立了 MPLS 工作组，开发出一种新的协议——多协议标记交换 MPLS (MultiProtocol Label Switching)。

“**多协议**”表示在 MPLS 的**上层**可以采用多种协议，例如：IP，IPX；可以使用**多种数据链路层协议**，例如：PPP，以太网，ATM 等。

“**标记**”是指每个分组被打上一个标记，根据该标记对分组进行转发。

![[Pasted image 20221126185929.png]]

MPLS 特点：
- MPLS 并没有取代 IP，而是作为一种 IP 增强技术，被广泛地应用在互联网中。
- MPLS 具有以下三个方面的特点：
	1. 支持面向连接的服务质量（QoS）；
	2. 支持流量工程，平衡网络负载；
	3. 有效地支持虚拟专用网 VPN。

## 9.1 MPLS的工作原理

### 9.1.1 基本工作过程

IP 分组的转发
	1. 在传统的 IP 网络中，分组每到达一个路由器后，都必须提取出其目的地址，按目的地址查找路由表，并按照“最长前缀匹配”的原则找到下一跳的 IP 地址（请注意，前缀的长度是不确定的）。
	2. 当网络很大时，查找含有大量项目的路由表要花费很多的时间。
	3. 在出现突发性的通信量时，往往还会使缓存溢出，这就会引起分组丢失、传输时延增大和服务质量下降。

![[Pasted image 20221126190328.png]]

#### MPLS协议的基本原理

- 在 **MPLS 域的入口**处，给每一个 IP 数据报打上**固定长度“标记”**，然后对打上标记的 IP 数据报用**硬件进行转发**。
- 采用硬件技术对打上标记的 IP 数据报进行转发就称为**标记交换**。
- “交换”也表示在转发时不再上升到第三层查找转发表，而是**根据标记在第二层（链路层）用硬件进行转发**。
- MPLS 域 (MPLS domain) 是指该域中有许多彼此相邻的路由器，并且所有的路由器都是支持 MPLS 技术的**标记交换路由器 LSR** (Label Switching Router)。
- LSR 同时具有标记交换和路由选择这两种功能，**标记交换功能是为了快速转发，但在这之前LSR 需要使用路由选择功能构造转发表**。

![[Pasted image 20221126190531.png]]

#### MPLS 的基本工作过程

(1)  MPLS 域中的各 LSR 使用专门的**标记分配协议 LDP** 交换报文，并找出**标记交换路径 LSP**。各 LSR 根据这些路径**构造出分组转发表**。

(2)  分组进入到 MPLS 域时， MPLS **入口结点把分组打上标记**，并按照转发表将分组转发给下一个 LSR。给 IP 数据报打标记的过程叫做**分类** (classification)。
(3) 一个标记仅仅在两个标记交换路由器 LSR 之间才有意义。分组每经过一个 LSR，LSR 就要做**两件事**：一是**转发**，二是更换新的标记，即把入标记更换成为出标记。这就叫做**标记对换** (label swapping)。

![[Pasted image 20221126191120.png]]

(4) 当分组离开 MPLS 域时，MPLS 出口结点把分组的标记去除。再以后就按照一般分组的转发方法进行转发。

![[Pasted image 20221126191144.png]]

### 9.1.2 转发等价类 FEC

- MPLS 有个很重要的概念就是转发等价类 FEC (Forwarding Equivalence Class)。
- “转发等价类”就是路由器按照同样方式对待的分组的集合
- “按照同样方式对待”表示：从同样接口转发到同样的下一跳地址，并且具有同样服务类别和同样丢弃优先级等。
- 划分 FEC 的方法不受什么限制，这都由网络管理员来控制，因此非常灵活。
- 入口结点并不是给每一个分组指派一个不同的标记，而是将属于同样 FEC 的分组都指派同样的标记。
- FEC 和标记是一一对应的关系。

![[Pasted image 20221126191249.png]]

## 9.2 MPLS 首部的位置与格式

MPLS 并不要求下层的网络都使用面向连接的技术。

下层的网络并不提供打标记的手段，而 IPv4 数据报首部也没有多余的位置存放 MPLS 标记。

这就需要使用一种封装技术：在把 IP 数据报封装成以太网帧之前，先要插入一个 MPLS 首部。

从层次的角度看，MPLS 首部就处在第二层和第三层之间。

![[Pasted image 20221126191318.png]]